{% extends "app/layout.html" %}
{% load staticfiles %}
{% block content %}
  <h1>CellQ <small>v{{ version }}</small></h1>
  <ul>
    <li>Cell Ratio Analysis</li>
    <li>Cell Count Estimation</li>
  </ul>

  <form id="add-photos" action="{% url 'home' %}" class="dropzone">
    {% csrf_token %}
  </form>
  <hr />
  <div>
    <h1>Results</h1>
    {% if user.is_authenticated %}

    <table id="result-list" class="display" cellspacing="0" width="100%">
      <thead>
        <tr>
          <th>Viewer</th>
          <th>File Name</th>
          <th>Area</th>
          <th>Count</th>
          <th>Created</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>

    {% else %}

    <div>Log in to save your results</div>

    {% endif %}
  </div>

{% endblock %}
{% block head-styles %}
  <link rel="stylesheet" type="text/css" href="{% static 'app/content/basic.css' %}" />
  <link rel="stylesheet" type="text/css" href="{% static 'app/content/dropzone.css' %}" />
  <!--
  <link rel="stylesheet" type="text/css" href="//cdn.datatables.net/1.10.10/css/dataTables.bootstrap.css"/>
  <link rel="stylesheet" type="text/css" href="//cdn.datatables.net/scroller/1.4.0/css/scroller.bootstrap.css"/>
  -->
  <link rel="stylesheet" type="text/css" href="//cdn.datatables.net/1.10.10/css/jquery.dataTables.min.css"/>
  <link rel="stylesheet" type="text/css" href="//cdn.datatables.net/scroller/1.4.0/css/scroller.dataTables.min.css"/>
  <link rel="stylesheet" type="text/css" href="{% static 'app/content/spinkit.css' %}" />
 
  <style type="text/css">
    #icon {
      display: inline-block;
      width: 64px;
      height: 64px;
    }
    .dropzone .dz-message {
      font-size: large;
    }
    div.DTS div.dataTables_scrollBody {
      background: white;
    }
    .cellq-icon {
      display: inline-block;
      width: 22px;
      height: 22px;
    }
  </style>
{% endblock %}
{% block scripts %}
  <script src="{% static 'app/scripts/dropzone.js' %}"></script>
  <script src="{% static 'app/scripts/underscore-min.js' %}"></script>
  <!--
  <script type="text/javascript" src="//cdn.datatables.net/1.10.10/js/dataTables.bootstrap.js"></script>
  -->
  <script type="text/javascript" src="//cdn.datatables.net/1.10.10/js/jquery.dataTables.min.js"></script>
  <script type="text/javascript" src="//cdn.datatables.net/scroller/1.4.0/js/dataTables.scroller.min.js"></script>
  <script type="text/template" id="loading-template">
    <div class="sk-fading-circle">
      <div class="sk-circle1 sk-circle"></div>
      <div class="sk-circle2 sk-circle"></div>
      <div class="sk-circle3 sk-circle"></div>
      <div class="sk-circle4 sk-circle"></div>
      <div class="sk-circle5 sk-circle"></div>
      <div class="sk-circle6 sk-circle"></div>
      <div class="sk-circle7 sk-circle"></div>
      <div class="sk-circle8 sk-circle"></div>
      <div class="sk-circle9 sk-circle"></div>
      <div class="sk-circle10 sk-circle"></div>
      <div class="sk-circle11 sk-circle"></div>
      <div class="sk-circle12 sk-circle"></div>
    </div>
  </script>
  <script type="text/template" id="viewer-btn-template">
    <a class="btn btn-default btn-xs viewer-btn" data-toggle="tooltip" data-placement="right" 
       data-container="body" title="Image Preview" target="_blank" href="<%= task_url %>" role="button">
      <span class="glyphicon glyphicon-new-window"></span> Image
    </a>
  </script>
  <script type="text/template" id="cellq-name-template">
    <img class="cellq-icon" src="{% static 'app/images/cellq_icon.png' %}"> <%= name %>
  </script>
  <script>
    Dropzone.options.addPhotos = {
      maxFilesize: 100, // MB
      uploadMultiple: false,
      maxFiles: 1,
      dictDefaultMessage: 'Drop image here to upload',
      init: function () {
        this.on('success', function (file, response) {
          //console.log(file, response);
          window.location = file.xhr.responseURL;
        });
      }
    };
    $(document).ready(function () {
      var running_template = '<i>Running ' + $('#loading-template').html() + '</i>';
      var view_btn_compiled = _.template($('#viewer-btn-template').html());
      var cellq_name_compiled = _.template($('#cellq-name-template').html());
      var date_now = (new Date()).toLocaleDateString();
      $('#result-list').DataTable({
        ajax: '/task',
        deferRender: true,
        scroller: true,
        scrollY: 500,
        order: [[4, 'desc']],
        columns: [
          {
            name: 'viewer', data: 'url', width: '50px', orderable: false,
            render: function (data, type, full, meta) {
              if (type === 'display')
                return view_btn_compiled({task_url: data});
              else
                return data;
            }
          },
          {
            name: 'file-name', data: 'name',
            render: function (data, type, full, meta) {
              if (type === 'display')
                return cellq_name_compiled({name: data});
              else
                return data;
            }
          },
          {
            name: 'area', type: 'num', data: 'result.ratio', defaultContent: running_template,
            render: function (data, type, full, meta) {
              return type === 'display' ? Math.round(data * 10000) / 100 + '%' : data;
            }
          },
          {
            name: 'count', type: 'num', data: 'result.count_min', defaultContent: running_template
          },
          {
            name: 'created', type: 'date', data: 'created',
            render: function (data, type, full, meta) {
              var date = (new Date(data));
              if (type === 'display') {
                var date_str = date.toLocaleDateString();
                if (date_now === date_str)
                  return date.toLocaleTimeString();
                else
                  return date_str;
              }
              else
                return date;
            }
          }
        ],
        createdRow: function (row, data, index) {
          // initialize bootstrap tooltip
          $('.viewer-btn', row).tooltip();
        }
      });
    });
  </script>
{% endblock %}