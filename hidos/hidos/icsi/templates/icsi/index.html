{% extends "app/layout.html" %}
{% load staticfiles %}
{% block content %}
  <h1>ICSI <small>v{{ version }}</small></h1>
  <ul>
    <li>Automatic ovum crop out</li>
    <li>Grade estimation</li>
  </ul>

  <form id="add-photos" action="{% url 'icsi' %}" class="dropzone">
    {% csrf_token %}
  </form>
  <hr />
  <div>
    <h1>Ovum Grade</h1>
    {% if user.is_authenticated %}
    
    <!-- 
    <table id="task-list" class="display" cellspacing="0" width="100%">
        <thead>
            <tr>
                <th>Viewer</th>
                <th>File Name</th>
                <th>Status</th>
            </tr>
        </thread>
        <tbody>
        </tbody>
    </table>



    </hr>

    -->
    <table id="result-list" class="display" cellspacing="0" width="100%">
      <thead>
        <tr>
          <th>Viewer</th>
          <th>Original File Name</th>
          <th>Ovum ID</th>
          <th>A</th> 
          <th>B</th>
          <th>C</th>
          <th>D</th>
          <th>E</th>
          <th>Created Date</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>

    {% else %}

    <div>Log in to save your results</div>

    {% endif %}
  </div>

{% endblock %}
{% block head-styles %}
  <link rel="stylesheet" type="text/css" href="{% static 'app/content/basic.css' %}" />
  <link rel="stylesheet" type="text/css" href="{% static 'app/content/dropzone.css' %}" />
  <!--
  <link rel="stylesheet" type="text/css" href="//cdn.datatables.net/1.10.10/css/dataTables.bootstrap.css"/>
  <link rel="stylesheet" type="text/css" href="//cdn.datatables.net/scroller/1.4.0/css/scroller.bootstrap.css"/>
  -->
  <link rel="stylesheet" type="text/css" href="//cdn.datatables.net/1.10.10/css/jquery.dataTables.min.css"/>
  <link rel="stylesheet" type="text/css" href="//cdn.datatables.net/scroller/1.4.0/css/scroller.dataTables.min.css"/>
  <link rel="stylesheet" type="text/css" href="{% static 'app/content/spinkit.css' %}" />
 
  <style type="text/css">
    #icon {
      display: inline-block;
      width: 64px;
      height: 64px;
    }
    .dropzone .dz-message {
      font-size: large;
    }
    div.DTS div.dataTables_scrollBody {
      background: white;
    }
    .cellq-icon {
      display: inline-block;
      width: 22px;
      height: 22px;
    }
    .preview-img {
      padding: 10px;
    }
    .preview-img img {
      padding: 10px 0px 0px;
    }
  </style>
{% endblock %}
{% block scripts %}
  <script src="{% static 'app/scripts/dropzone.js' %}"></script>
  <script src="{% static 'app/scripts/underscore-min.js' %}"></script>
  <!--
  <script type="text/javascript" src="//cdn.datatables.net/1.10.10/js/dataTables.bootstrap.js"></script>
  -->
  <script type="text/javascript" src="//cdn.datatables.net/1.10.10/js/jquery.dataTables.min.js"></script>
  <script type="text/javascript" src="//cdn.datatables.net/scroller/1.4.0/js/dataTables.scroller.min.js"></script>
  <script type="text/template" id="loading-template">
    <div class="sk-fading-circle">
      <div class="sk-circle1 sk-circle"></div>
      <div class="sk-circle2 sk-circle"></div>
      <div class="sk-circle3 sk-circle"></div>
      <div class="sk-circle4 sk-circle"></div>
      <div class="sk-circle5 sk-circle"></div>
      <div class="sk-circle6 sk-circle"></div>
      <div class="sk-circle7 sk-circle"></div>
      <div class="sk-circle8 sk-circle"></div>
      <div class="sk-circle9 sk-circle"></div>
      <div class="sk-circle10 sk-circle"></div>
      <div class="sk-circle11 sk-circle"></div>
      <div class="sk-circle12 sk-circle"></div>
    </div>
  </script>
  <script type="text/template" id="viewer-img-template">
    <img src="<%= result_img %>" class="img-rounded"  width="50px" height="50px">   
  </script>
  <script type="text/template" id="cellq-name-template">
         <a class="btn btn-default btn-xs viewer-btn" data-toggle="popover" data-placement="top" 
       data-container="body" data-html="true" data-trigger="hover"
       title="<div class='preview-img'>Original Image Preview <img src='<%= input_img %>' width='100%' height='100%'></div>"
       target="_blank" href="<%= input_img %>" role="button">
      <img class="cellq-icon" src="{% static 'app/images/cellq_icon.png' %}"> <%= name %>

    </a>

  </script>

    <script type="text/template" id="checked-template">
    <div class="glyphicon glyphicon-check"></div>
    </script>


    <script type="text/template" id="unchecked-template">
    <div class="glyphicon glyphicon-unchecked"></div>
    </script>

  <script>
    $(document).ready(function () {
      if ($('#result-list').length) { // check if user is logged in
        var running_template = $('#loading-template').html() ;
        var view_btn_compiled = _.template($('#viewer-img-template').html());
        var cellq_name_compiled = _.template($('#cellq-name-template').html());
        var checked_compiled = _.template($('#checked-template').html());
        var unchecked_compiled = _.template($('#unchecked-template').html());
        var date_now = (new Date()).toLocaleDateString();
        var result_table;
        result_table = $('#result-list').DataTable({
          ajax: 'api/v1/tasks',
          deferRender: true,
          scroller: true,
          scrollY: 500,
          order: [[4, 'desc']],
          columns: [
            {
              name: 'viewer', data: 'result_img', width: '50px', orderable: false,
              render: function (data, type, row, meta) {
                if (type === 'display')
                  return view_btn_compiled({
                    result_img: row.result_img
                  });
                else
                  return data;
              }
            },
            {
              name: 'file-name', data: 'name',
              render: function (data, type, row, meta) {
                if (type === 'display')
                  return cellq_name_compiled({ 
                    name: data, 
                    input_img: row.input_img
                  });
                else
                  return data;
              }
            },
            {
              name: 'OvumID', type: 'num', data: 'count', width: '70px',
            },

            {
              name: 'A', type: 'text', data: 'grade', defaultContent: running_template, width: '20px',
                    render: function(data, type, row, meta){
                    if(data === 'A'){
                        return checked_compiled()
                    
                    }else{
                        return unchecked_compiled()
                    }
                }
            },
            {
              name: 'B', type: 'text', data: 'grade', defaultContent: running_template, width: '20px',
                    render: function(data, type, row, meta){
                    if(data === 'B'){
                        return checked_compiled()
                    
                    }else{
                        return unchecked_compiled()
                    }
                }

            },
            {
              name: 'C', type: 'text', data: 'grade', defaultContent: running_template, width: '20px',
                    render: function(data, type, row, meta){
                    if(data === 'C'){
                        return checked_compiled()
                    
                    }else{
                        return unchecked_compiled()
                    }
                }

            },
            {
              name: 'D', type: 'text', data: 'grade', defaultContent: running_template, width: '20px',
                    render: function(data, type, row, meta){
                    if(data === 'D'){
                        return checked_compiled()
                    
                    }else{
                        return unchecked_compiled()
                    }
                }

            },
            {
              name: 'E', type: 'text', data: 'grade', defaultContent: running_template, width: '20px',
                    render: function(data, type, row, meta){
                    if(data === 'F'){
                        return checked_compiled()
                    
                    }else{
                        return unchecked_compiled()
                    }
                }

            },
            {
              name: 'created', type: 'date', data: 'created', width: '100px',
              render: function (data, type, row, meta) {
                var date = (new Date(data));
                if (type === 'display') {
                  var date_str = date.toLocaleDateString();
                  if (date_now === date_str)
                    return date.toLocaleTimeString();
                  else
                    return date_str;
                }
                else
                  return date;
              }
            }
          ],
          createdRow: function (row, data, index) {
            // initialize bootstrap tooltip
            $('.viewer-btn', row).tooltip();
          }
        });

        // get status 
        var unfinished = ['queued', 'running'];
        var unfinished_task_ids;
        var polling = false;
        $('#result-list').on('xhr.dt', function (e, settings, json, xhr) {
          // json data loaded
          // get a list of queued and running tasks
          //console.log(e, settings, json, xhr);
          if (!json) return; // consecutive ajax.reload() may result in 'abort' status
          unfinished_task_ids = _.pluck(_.filter(json.data, (t) => _.contains(unfinished, t.result)), 'id');
          //console.log(unfinished_task_ids);
          if (unfinished_task_ids.length > 0 && polling == false) {
            polling = true;
            var finished = ['success', 'failed'];
            var poll = function () {
              $.ajax({
                url: '/api/v1/tasks/status',
                dataType: 'json',
                type: 'GET',
                data: { 'id': unfinished_task_ids },
                traditional: true,
                success: function (data, status) {
                  //console.log(_.some(finished, (c) => _.contains(_.pluck(data.data, 'result_status'), c)));
                  if (_.some(finished, (c) => _.contains(_.pluck(data.data, 'result'), c))) {
                    polling = false;
                    result_table.ajax.reload();
                  } else
                    setTimeout(poll, 3000);
                }
              });
            };
            poll();
          } else {
            polling = false;
          }
        });
        Dropzone.options.addPhotos = {
          maxFilesize: 256, // MB
          uploadMultiple: false,
          parallelUploads: 2,
          maxFiles: null,
          thumbnailWidth: null,
          thumbnailHeight: 120,
          dictDefaultMessage: 'Drop one or more images here to upload',
          init: function () {
            this.on('success', function (file, response) {
              // reload result table data
              result_table.ajax.reload()
            });
          }
        };
      } else {
        Dropzone.options.addPhotos = {
          maxFilesize: 256, // MB
          uploadMultiple: false,
          maxFiles: 1,
          thumbnailWidth: null,
          thumbnailHeight: 120,
          dictDefaultMessage: 'Drop image here to upload',
          init: function () {
            this.on('success', function (file, response) {
              //console.log(file, response);
              window.location = '/' + response;
            });
          }
        };
      }
    });
  </script>
{% endblock %}